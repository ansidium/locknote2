name: Windows QA

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  qa:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup vcpkg
        shell: pwsh
        run: |
          $vcpkgRoot = Join-Path $env:RUNNER_TEMP "vcpkg"
          if (-not (Test-Path $vcpkgRoot)) {
            git clone --depth 1 https://github.com/microsoft/vcpkg $vcpkgRoot
          }
          & "$vcpkgRoot\\bootstrap-vcpkg.bat" -disableMetrics
          "VCPKG_ROOT=$vcpkgRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          $vcpkgRoot | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Run Windows QA pipeline
        shell: pwsh
        run: |
          ./scripts/windows-qa.ps1 -SkipCppcheck
